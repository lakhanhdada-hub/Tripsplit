<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TripSplit Pro</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #f8fafc;
            margin: 0; padding: 0;
        }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 50; }
        .modal.active { display: flex; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Header -->
    <div id="header-bg" class="safe-top p-6 rounded-b-[2.5rem] shadow-xl text-white transition-colors duration-500 bg-indigo-600">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-xl font-black italic tracking-tighter flex items-center gap-2">
                    <i data-lucide="zap" class="w-5 h-5"></i> TRIPSPLIT PRO
                </h1>
                <button onclick="app.clearData()" class="p-2 bg-white/10 rounded-full"><i data-lucide="refresh-ccw" class="w-4 h-4"></i></button>
            </div>
            
            <div class="bg-white/10 backdrop-blur-md rounded-[2rem] p-6 border border-white/20 flex items-center justify-between">
                <div class="text-center flex-1">
                    <p class="text-[10px] uppercase font-bold opacity-70">Quỹ còn</p>
                    <p id="stat-fund" class="text-3xl font-black">0K</p>
                </div>
                <div class="w-[1px] h-10 bg-white/20"></div>
                <div class="text-center flex-1">
                    <p class="text-[10px] uppercase font-bold opacity-70">Tổng chi</p>
                    <p id="stat-spent" class="text-3xl font-black">0K</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-md mx-auto p-4 mt-2 pb-32">
        <!-- Tab Báo Cáo -->
        <div id="tab-report" class="tab-content active space-y-4">
            <div class="bg-white p-2 rounded-2xl flex shadow-sm border border-slate-100">
                <input id="input-member" class="flex-1 px-4 py-3 outline-none font-bold text-sm bg-transparent" placeholder="Thêm tên thành viên...">
                <button onclick="app.addMember()" class="bg-slate-900 text-white p-3 rounded-xl">
                    <i data-lucide="user-plus"></i>
                </button>
            </div>
            <div id="member-list" class="space-y-4"></div>
        </div>

        <!-- Tab Lịch Sử -->
        <div id="tab-history" class="tab-content space-y-3">
            <div id="expense-list" class="space-y-3"></div>
        </div>
    </main>

    <!-- Floating Action Button -->
    <div class="fixed bottom-24 left-0 right-0 flex justify-center pointer-events-none">
        <button onclick="app.openExpenseModal()" class="w-16 h-16 bg-slate-900 text-white rounded-full shadow-2xl flex items-center justify-center pointer-events-auto active:scale-90 transition-transform border-4 border-white">
            <i data-lucide="plus" class="w-8 h-8"></i>
        </button>
    </div>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-slate-100 safe-bottom p-4 flex justify-around rounded-t-[2.5rem] shadow-inner z-40">
        <button onclick="app.switchTab('report')" id="nav-report" class="flex flex-col items-center gap-1 text-indigo-600">
            <i data-lucide="layout-grid"></i>
            <span class="text-[10px] font-black uppercase tracking-tighter">Báo cáo</span>
        </button>
        <div class="w-16"></div>
        <button onclick="app.switchTab('history')" id="nav-history" class="flex flex-col items-center gap-1 text-slate-300">
            <i data-lucide="history"></i>
            <span class="text-[10px] font-black uppercase tracking-tighter">Lịch sử</span>
        </button>
    </nav>

    <!-- Modal: Chi Tiêu -->
    <div id="modal-expense" class="modal items-end">
        <div class="bg-white w-full rounded-t-[3rem] p-8 safe-bottom">
            <h2 class="text-xl font-black uppercase mb-6 italic flex items-center gap-2">
                <i data-lucide="edit-3"></i> Ghi chi tiêu
            </h2>
            <div class="space-y-4 mb-6">
                <input id="exp-desc" class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-bold" placeholder="Nội dung: Mua xăng, ăn sáng...">
                <input id="exp-amount" type="number" class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-black text-3xl" placeholder="Số tiền (K)">
            </div>
            <button onclick="app.saveExpense()" class="w-full py-5 bg-slate-900 text-white rounded-3xl font-black uppercase">Xác nhận</button>
            <button onclick="app.closeModals()" class="w-full py-4 text-slate-400 font-bold mt-2">Hủy</button>
        </div>
    </div>

    <!-- Modal: Đóng Quỹ -->
    <div id="modal-contribute" class="modal items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-8 text-center">
            <h3 class="font-black uppercase mb-2">Đóng quỹ</h3>
            <p id="contribute-name" class="text-sm text-slate-400 mb-6 font-bold"></p>
            <input id="contribute-amount" type="number" class="w-full p-5 bg-slate-50 rounded-2xl mb-6 font-black text-4xl text-center text-emerald-600 outline-none" placeholder="0K">
            <div class="flex gap-3">
                <button onclick="app.closeModals()" class="flex-1 py-4 bg-slate-100 rounded-2xl font-black uppercase text-slate-400">Hủy</button>
                <button onclick="app.saveContribution()" class="flex-[2] py-4 bg-emerald-500 text-white rounded-2xl font-black uppercase">Nộp tiền</button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            members: JSON.parse(localStorage.getItem('ts_m') || '[]'),
            expenses: JSON.parse(localStorage.getItem('ts_e') || '[]'),
            contributions: JSON.parse(localStorage.getItem('ts_c') || '[]'),
            currentMemberId: null,

            init() {
                lucide.createIcons();
                this.render();
            },

            save() {
                localStorage.setItem('ts_m', JSON.stringify(this.members));
                localStorage.setItem('ts_e', JSON.stringify(this.expenses));
                localStorage.setItem('ts_c', JSON.stringify(this.contributions));
                this.render();
            },

            addMember() {
                const name = document.getElementById('input-member').value.trim();
                if (!name) return;
                this.members.push({ id: Date.now(), name });
                document.getElementById('input-member').value = '';
                this.save();
            },

            deleteMember(id) {
                if (!confirm("Xóa thành viên này?")) return;
                this.members = this.members.filter(m => m.id !== id);
                this.contributions = this.contributions.filter(c => c.memberId !== id);
                this.save();
            },

            openExpenseModal() {
                document.getElementById('modal-expense').classList.add('active');
            },

            saveExpense() {
                const desc = document.getElementById('exp-desc').value;
                const amount = parseFloat(document.getElementById('exp-amount').value);
                if (!desc || !amount) return;
                this.expenses.unshift({ id: Date.now(), desc, amount, date: new Date().toLocaleDateString('vi-VN') });
                document.getElementById('exp-desc').value = '';
                document.getElementById('exp-amount').value = '';
                this.closeModals();
                this.save();
            },

            openContribute(id, name) {
                this.currentMemberId = id;
                document.getElementById('contribute-name').innerText = name;
                document.getElementById('modal-contribute').classList.add('active');
            },

            saveContribution() {
                const amount = parseFloat(document.getElementById('contribute-amount').value);
                if (!amount) return;
                this.contributions.push({ memberId: this.currentMemberId, amount, date: new Date().toLocaleDateString('vi-VN') });
                document.getElementById('contribute-amount').value = '';
                this.closeModals();
                this.save();
            },

            closeModals() {
                document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            },

            switchTab(tab) {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById('tab-' + tab).classList.add('active');
                document.getElementById('nav-report').classList.toggle('text-indigo-600', tab === 'report');
                document.getElementById('nav-report').classList.toggle('text-slate-300', tab !== 'report');
                document.getElementById('nav-history').classList.toggle('text-indigo-600', tab === 'history');
                document.getElementById('nav-history').classList.toggle('text-slate-300', tab !== 'history');
            },

            clearData() {
                if (confirm("Xóa toàn bộ dữ liệu?")) {
                    localStorage.clear();
                    location.reload();
                }
            },

            render() {
                const totalSpent = this.expenses.reduce((s, e) => s + e.amount, 0);
                const totalIn = this.contributions.reduce((s, c) => s + c.amount, 0);
                const fund = totalIn - totalSpent;

                document.getElementById('stat-fund').innerText = fund.toLocaleString() + 'K';
                document.getElementById('stat-spent').innerText = totalSpent.toLocaleString() + 'K';
                document.getElementById('header-bg').className = `safe-top p-6 rounded-b-[2.5rem] shadow-xl text-white transition-colors duration-500 ${fund < 0 ? 'bg-rose-500' : 'bg-indigo-600'}`;

                // Render Members
                const list = document.getElementById('member-list');
                list.innerHTML = this.members.map(m => {
                    const paid = this.contributions.filter(c => c.memberId === m.id).reduce((s, c) => s + c.amount, 0);
                    const shared = this.members.length > 0 ? totalSpent / this.members.length : 0;
                    const bal = paid - shared;
                    return `
                        <div class="bg-white rounded-[2rem] p-5 shadow-sm border border-slate-100">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-black uppercase text-slate-800">${m.name}</h3>
                                <div class="flex gap-2">
                                    <button onclick="app.openContribute(${m.id}, '${m.name}')" class="bg-emerald-500 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">Nộp quỹ</button>
                                    <button onclick="app.deleteMember(${m.id})" class="text-slate-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="bg-slate-50 p-2 rounded-xl text-center">
                                    <p class="text-[8px] font-bold text-slate-400 uppercase">Đã nộp</p>
                                    <p class="font-black text-xs">${paid}K</p>
                                </div>
                                <div class="bg-slate-50 p-2 rounded-xl text-center">
                                    <p class="text-[8px] font-bold text-slate-400 uppercase">Cần chi</p>
                                    <p class="font-black text-xs">${shared.toFixed(1)}K</p>
                                </div>
                                <div class="p-2 rounded-xl text-center ${bal >= 0 ? 'bg-indigo-50 text-indigo-600' : 'bg-rose-50 text-rose-600'}">
                                    <p class="text-[8px] font-bold opacity-60 uppercase">Dư/Nợ</p>
                                    <p class="font-black text-xs">${bal.toFixed(1)}K</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Render History
                const eList = document.getElementById('expense-list');
                eList.innerHTML = this.expenses.map(e => `
                    <div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-100">
                        <div class="flex items-center gap-3">
                            <div class="p-3 bg-rose-50 text-rose-500 rounded-xl"><i data-lucide="shopping-cart" class="w-4 h-4"></i></div>
                            <div>
                                <p class="font-black text-sm">${e.desc}</p>
                                <p class="text-[10px] text-slate-400 font-bold uppercase">${e.date}</p>
                            </div>
                        </div>
                        <p class="font-black text-rose-500">-${e.amount}K</p>
                    </div>
                `).join('');

                lucide.createIcons();
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
